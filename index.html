<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projet RCW - Analyse D√©mographique</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="data.js"></script>

    <style>
        /* --- STYLE CSS (Mise en page) --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f0f2f5; color: #333; }
        
        /* En-t√™te */
        header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 1.5rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        header h1 { margin: 0; font-size: 1.8rem; }
        header p { margin: 5px 0 0; opacity: 0.8; font-size: 0.9rem; }
        
        /* Conteneur Principal */
        .container { display: flex; flex-wrap: wrap; padding: 20px; gap: 20px; max-width: 1200px; margin: 0 auto; }
        
        /* Colonne de Gauche (Contr√¥les) */
        .sidebar { flex: 1; min-width: 250px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: fit-content; }
        
        /* Colonne de Droite (Visu) */
        .main-content { flex: 3; min-width: 600px; display: flex; flex-direction: column; gap: 20px; }
        
        /* Cartes (Panneaux blancs) */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; font-size: 1.2rem; color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-bottom: 20px; }

        /* Contr√¥les Formulaire */
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #7f8c8d; }
        select { width: 100%; padding: 12px; margin-bottom: 25px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 1rem; background-color: #f9f9f9; }
        
        /* Indicateurs Cl√©s (KPI) */
        .kpi-box { text-align: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .kpi-value { font-size: 2.2rem; font-weight: bold; color: #2c3e50; }
        .kpi-label { font-size: 0.85rem; text-transform: uppercase; color: #95a5a6; letter-spacing: 1px; }

        /* Carte Thermique (Grid) */
        #map-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 4px; padding: 10px; }
        .dept-box { 
            aspect-ratio: 1; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 0.75rem; font-weight: bold; 
            cursor: pointer; border-radius: 4px; transition: transform 0.2s, box-shadow 0.2s;
        }
        .dept-box:hover { transform: scale(1.15); z-index: 10; box-shadow: 0 0 10px rgba(0,0,0,0.2); border: 1px solid white; }
        
        /* Indicateur de Mode (Simulation vs R√©el) */
        #connection-status { font-size: 0.8rem; padding: 5px 10px; border-radius: 20px; display: inline-block; margin-top: 10px; }
        .status-ok { background-color: #d4edda; color: #155724; }
        .status-mock { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>

<header>
    <h1>üåç Observatoire D√©mographique (RCW)</h1>
    <p>Analyse de l'√©volution du taux d'accroissement naturel en France (2013-2023)</p>
    <div id="status-container"></div>
</header>

<div class="container">
    <div class="sidebar">
        <h2>üîç S√©lection</h2>
        <label for="deptSelect">D√©partement :</label>
        <select id="deptSelect"></select>

        <div class="kpi-box">
            <div class="kpi-value" id="val-pop">-</div>
            <div class="kpi-label">Population (2023)</div>
        </div>
        
        <div class="kpi-box">
            <div class="kpi-value" id="val-taux">-</div>
            <div class="kpi-label">Taux d'Accroissement</div>
        </div>

        <p style="font-size: 0.8rem; color: #bdc3c7; margin-top: 30px; text-align: center;">
            Projet Universitaire - IUT Orsay<br>
            Donn√©es INSEE / Wikidata
        </p>
    </div>

    <div class="main-content">
        <div class="card">
            <h2>üìà √âvolution Temporelle (10 ans)</h2>
            <div style="height: 300px;">
                <canvas id="evolutionChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2>üó∫Ô∏è Carte Thermique (Moyenne D√©cennale)</h2>
            <p style="font-size: 0.9rem; color: #7f8c8d; margin-bottom: 15px;">
                Cliquez sur un carr√© pour voir le d√©tail du d√©partement. <br>
                <span style="color:#e74c3c">‚ñ†</span> D√©croissance | <span style="color:#27ae60">‚ñ†</span> Croissance
            </p>
            <div id="map-container"></div>
        </div>
    </div>
</div>

<script>
    /* --- CONFIGURATION --- */
    // Adaptez l'URL si votre GraphDB est distant ou a un autre nom de repo
    const GRAPHDB_URL = 'http://localhost:7200/repositories/projet_rcw';
    
    // Requ√™te SPARQL officielle pour r√©cup√©rer les donn√©es
    const SPARQL_QUERY = `
        PREFIX ex: <http://example.org/ontology/>
        SELECT ?code ?annee ?taux ?pop
        WHERE {
            ?obs a ex:ObservationDemographique ;
                 ex:concerneDepartement ?dept ;
                 ex:aPourAnnee ?annee ;
                 ex:tauxAccroissement ?taux ;
                 ex:populationTotale ?pop .
            ?dept ex:codeINSEE ?code .
        }
    `;

    let myChart = null; // Variable globale pour le graphique

    /* --- INITIALISATION --- */
    window.onload = async function() {
        const statusDiv = document.getElementById('status-container');
        
        console.log("üîÑ Tentative de connexion √† GraphDB...");
        
        try {
            // 1. On essaie de contacter le vrai serveur S√©mantique
            await chargerDepuisGraphDB();
            
            // Si pas d'erreur, on affiche le statut "Connect√©"
            statusDiv.innerHTML = '<span id="connection-status" class="status-ok">üü¢ Connect√© au Web S√©mantique (GraphDB)</span>';
        
        } catch (erreur) {
            // 2. Si √ßa √©choue (Serveur √©teint, CORS, Base vide), on passe en mode secours
            console.warn("‚ö†Ô∏è GraphDB inaccessible : " + erreur.message);
            console.log("‚úÖ Basculement automatique sur les donn√©es simul√©es (data.js).");
            
            statusDiv.innerHTML = '<span id="connection-status" class="status-mock">üü† Mode Simulation (Donn√©es Locales)</span>';
            
            // V√©rification que le fichier data.js a bien √©t√© charg√©
            if (typeof dbData !== 'undefined') {
                initApp(dbData);
            } else {
                alert("ERREUR CRITIQUE : Impossible de charger les donn√©es.\n1. GraphDB ne r√©pond pas.\n2. Le fichier data.js est introuvable (lancez le script Python).");
            }
        }
    };

    /* --- FONCTIONS DE DONN√âES --- */

    // Tente de r√©cup√©rer les vraies donn√©es RDF via l'API REST de GraphDB
    async function chargerDepuisGraphDB() {
        const url = GRAPHDB_URL + '?query=' + encodeURIComponent(SPARQL_QUERY);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: { 
                'Accept': 'application/sparql-results+json' // Header indispensable
            }
        });

        if (!response.ok) throw new Error("Erreur HTTP " + response.status);

        const json = await response.json();
        const bindings = json.results.bindings;

        if (!bindings || bindings.length === 0) throw new Error("La requ√™te SPARQL n'a retourn√© aucun r√©sultat.");

        // On nettoie les donn√©es brutes SPARQL pour les rendre faciles √† utiliser
        const cleanData = bindings.map(row => ({
            code: row.code.value,
            annee: parseInt(row.annee.value),
            population: parseInt(row.pop.value),
            taux: parseFloat(row.taux.value)
        }));

        console.log(`‚úÖ ${cleanData.length} observations charg√©es depuis GraphDB.`);
        initApp(cleanData); // On lance l'app avec les vraies donn√©es
    }

    /* --- FONCTIONS D'AFFICHAGE (Vue) --- */

    // Initialise l'interface (Select + Carte)
    function initApp(data) {
        const select = document.getElementById('deptSelect');
        const mapDiv = document.getElementById('map-container');
        
        // Obtenir la liste unique des codes d√©partements
        const uniqueDepts = [...new Set(data.map(d => d.code))].sort();

        // Vider les conteneurs (au cas o√π)
        select.innerHTML = "";
        mapDiv.innerHTML = "";

        uniqueDepts.forEach(code => {
            // 1. Remplir le menu d√©roulant
            const opt = document.createElement('option');
            opt.value = code;
            opt.innerText = `D√©pt ${code}`;
            select.appendChild(opt);

            // 2. Cr√©er la case de la carte thermique
            const deptData = data.filter(d => d.code === code);
            // Calcul de la moyenne du taux sur la p√©riode
            const avgTaux = deptData.reduce((sum, d) => sum + d.taux, 0) / deptData.length;
            
            const div = document.createElement('div');
            div.className = 'dept-box';
            div.innerText = code;
            div.title = `D√©pt ${code} : Moyenne ${avgTaux.toFixed(2)}%`;
            
            // Logique de couleur (Vert positif, Rouge n√©gatif)
            const intensity = Math.min(Math.abs(avgTaux) * 200, 255); 
            if (avgTaux < 0) {
                // Nuance de Rouge
                div.style.backgroundColor = `rgb(255, ${255 - intensity}, ${255 - intensity})`;
                div.style.color = intensity > 150 ? 'white' : '#333';
            } else {
                // Nuance de Vert (Bleut√©)
                div.style.backgroundColor = `rgb(${255 - intensity}, 255, ${255 - intensity})`; 
                div.style.color = '#333';
            }
            
            // Interaction Clic sur la carte
            div.onclick = () => {
                select.value = code;
                updateDashboard(data);
            };

            mapDiv.appendChild(div);
        });

        // Charger les donn√©es du premier d√©partement de la liste
        if(uniqueDepts.length > 0) {
            updateDashboard(data);
        }

        // √âcouteur d'√©v√©nement sur le menu d√©roulant
        select.onchange = () => updateDashboard(data);
    }

    // Met √† jour les Graphiques et KPI quand on change de d√©partement
    function updateDashboard(dataSource) {
        const selectedCode = document.getElementById('deptSelect').value;
        // Filtrer et trier par ann√©e
        const dataDept = dataSource.filter(d => d.code === selectedCode).sort((a,b) => a.annee - b.annee);
        
        if (dataDept.length === 0) return;

        // --- Mise √† jour des KPI ---
        const lastRecord = dataDept[dataDept.length - 1]; // Derni√®re ann√©e disponible
        
        // Formatage Population (ex: 1 200 k)
        const popFormat = (lastRecord.population / 1000).toFixed(0) + ' k';
        document.getElementById('val-pop').innerText = popFormat;
        
        // Formatage Taux
        const tauxElem = document.getElementById('val-taux');
        tauxElem.innerText = lastRecord.taux + ' %';
        tauxElem.style.color = lastRecord.taux >= 0 ? '#27ae60' : '#c0392b'; // Vert ou Rouge

        // --- Mise √† jour du Graphique (Chart.js) ---
        const ctx = document.getElementById('evolutionChart').getContext('2d');
        
        // Si un graphique existe d√©j√†, on le d√©truit pour en recr√©er un
        if (myChart) myChart.destroy();
        
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dataDept.map(d => d.annee),
                datasets: [{
                    label: `Taux d'accroissement - D√©pt ${selectedCode}`,
                    data: dataDept.map(d => d.taux),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.15)',
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#2980b9',
                    pointRadius: 5,
                    fill: true,
                    tension: 0.3 // Courbe liss√©e
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: { color: '#f0f0f0' },
                        title: { display: true, text: 'Taux (%)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }
</script>

</body>
</html>